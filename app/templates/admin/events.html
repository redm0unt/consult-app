{% extends "base.html" %}
{% from "elements/general_elements.html" import render_empty_state_block %}
{% from "elements/management_macros.html" import management_controls, management_card, management_add_button, management_modal, management_delete_form %}

{% set page_description = "Обзор и управление мероприятиями школы" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='style/pages/admin/management.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/pages/admin/events.css') }}">
{% endblock %}

{% block content %}
{{ render_header(page_title, page_description) }}
<main class="content-main">
<section class="section" aria-label="Управление мероприятиями">
    {% call management_controls('Название, период, статус') %}
        {% if can_manage_events %}
        {{ management_add_button('data-events-add', 'Создать мероприятие') }}
        {% endif %}
    {% endcall %}

    {% if events %}
    <section class="management-grid management-grid--full events-grid" aria-label="Список мероприятий">
        {% for event in events %}
        {% set menu_config = event.menu_config if can_manage_events else None %}
        {% set detail_payload = {
            'title': event.title_text,
            'status': event.status_label,
            'statusModifier': event.status_modifier,
            'statusHint': event.status_hint,
            'period': event.period_text,
            'consultations': event.consultations_count,
            'durationMinutes': event.duration_minutes,
            'consultationDurationMinutes': event.consultation_duration_minutes,
            'teacherIds': event.teacher_ids,
            'teacherNames': event.teacher_names,
            'teacherCount': event.teacher_names | length,
            'meta': event.meta_items,
            'stats': event.stats,
            'bookings': event.bookings
        } %}
        {% call management_card('event', event.title_label, event.title_text, event.info_label, menu_config) %}
            <div class="event-card__body" data-event-card data-event-detail='{{ detail_payload | tojson | safe }}' role="button" tabindex="0" aria-label="Подробнее о {{ event.title_text }}">
                <div class="event-card__top">
                    <div class="event-card__status">
                        <span class="management-badge management-badge--{{ event.status_modifier }} event-card__status-badge">{{ event.status_label }}</span>
                        {% if event.status_hint %}
                        <span class="event-card__status-hint">{{ event.status_hint }}</span>
                        {% endif %}
                    </div>
                    <div class="event-card__period">
                        <span class="event-card__period-label">Период</span>
                        <span class="event-card__period-value">{{ event.period_text }}</span>
                    </div>
                </div>

                <div class="event-card__highlights">
                    <div class="event-card__highlight">
                        <span class="event-card__highlight-value">{{ event.consultations_count }}</span>
                        <span class="event-card__highlight-label">консультаций</span>
                    </div>
                    <div class="event-card__highlight">
                        <span class="event-card__highlight-value">{{ event.duration_minutes }}</span>
                        <span class="event-card__highlight-label">длительность, мин</span>
                    </div>
                    <div class="event-card__highlight">
                        <span class="event-card__highlight-value">{{ event.consultation_duration_minutes }}</span>
                        <span class="event-card__highlight-label">консультация, мин</span>
                    </div>
                </div>

                {% if event.meta_items %}
                <div class="event-card__meta-grid">
                    {% for item in event.meta_items %}
                    <div class="event-card__meta-item">
                        <span class="event-card__meta-label">{{ item.label }}</span>
                        <span class="event-card__meta-value">{{ item.value }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="event-card__details-cue" aria-hidden="true">
                    <span class="event-card__details-label">Подробнее</span>
                    <span class="event-card__details-icon" aria-hidden="true">→</span>
                </div>
            </div>
        {% endcall %}
        {% endfor %}
    </section>
    {% else %}
    {{ render_empty_state_block('Мероприятия не найдены. Создайте первое мероприятие, чтобы начать планирование') }}
    {% endif %}

    <div class="event-details-modal" data-event-details-modal aria-hidden="true">
        <div class="event-details-modal__overlay" data-event-details-close></div>
        <div class="event-details-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="event-details-title">
            <header class="event-details-modal__header">
                <div class="event-details-modal__header-texts">
                    <h2 id="event-details-title" class="event-details-modal__title" data-event-details-title>Мероприятие</h2>
                    <div class="event-details-modal__status" data-event-details-status-container>
                        <span class="management-badge event-details-modal__status-badge" data-event-details-status></span>
                        <span class="event-details-modal__status-hint" data-event-details-status-hint></span>
                    </div>
                </div>
                <button type="button" class="event-details-modal__close" data-event-details-close aria-label="Закрыть подробности">
                    <span aria-hidden="true">×</span>
                </button>
            </header>
            <section class="event-details-modal__section">
                <h3 class="event-details-modal__section-label">Период</h3>
                <p class="event-details-modal__period" data-event-details-period></p>
            </section>
            <section class="event-details-modal__section event-details-modal__section--highlights">
                <div class="event-details-modal__highlight" data-event-details-highlight-consultations>
                    <span class="event-details-modal__highlight-value" data-event-details-consultations>0</span>
                    <span class="event-details-modal__highlight-label">консультаций</span>
                </div>
                <div class="event-details-modal__highlight" data-event-details-highlight-duration>
                    <span class="event-details-modal__highlight-value" data-event-details-duration>0</span>
                    <span class="event-details-modal__highlight-label">длительность, мин</span>
                </div>
                <div class="event-details-modal__highlight" data-event-details-highlight-consultation-duration>
                    <span class="event-details-modal__highlight-value" data-event-details-consultation-duration>0</span>
                    <span class="event-details-modal__highlight-label">консультация, мин</span>
                </div>
            </section>
            <section class="event-details-modal__section event-details-modal__section--teachers" data-event-details-teachers-section>
                <h3 class="event-details-modal__section-label">Учителя</h3>
                <ul class="event-details-modal__teachers-list" data-event-details-teachers></ul>
            </section>
            <section class="event-details-modal__section">
                <h3 class="event-details-modal__section-label">Ключевые отметки</h3>
                <div class="event-details-modal__meta" data-event-details-meta></div>
            </section>
            <section class="event-details-modal__section" data-event-details-stats-section>
                <div class="event-details-modal__section-heading">
                    <h3 class="event-details-modal__section-label">Статистика</h3>
                    <p class="event-details-modal__section-note">Данные обновляются автоматически</p>
                </div>
                <div class="event-details-modal__stats-grid" data-event-details-stats></div>
            </section>
            <section class="event-details-modal__section" data-event-details-bookings-section>
                <h3 class="event-details-modal__section-label">Занятые помещения</h3>
                <ul class="event-details-modal__bookings-list" data-event-details-bookings></ul>
            </section>
        </div>
    </div>

    {% if can_manage_events %}
    {% set event_form = event_form_data or {} %}
    {% set selected_teacher_ids = event_form.get('selected_teacher_ids', []) %}
    {% if selected_teacher_ids is string %}
        {% set selected_teacher_ids = [selected_teacher_ids] %}
    {% elif selected_teacher_ids is not iterable %}
        {% set selected_teacher_ids = [selected_teacher_ids] %}
    {% endif %}
    {% set selected_teacher_ids = selected_teacher_ids | list %}
    {% set current_step_value = event_form.get('current_step', 'basic') %}
    {% set all_teachers_selected = (teacher_options | length > 0) and (selected_teacher_ids | length >= teacher_options | length) %}
    {% set event_modal_config = {
        'prefix': 'events',
        'show': show_event_form,
        'mode': event_form_mode or 'create',
        'dataset_id_attr': 'event-id',
        'dataset_id_value': event_form_event_id,
        'title_create': 'Создание мероприятия',
        'title_update': 'Редактирование мероприятия',
        'submit_create': 'Создать',
        'submit_update': 'Сохранить изменения',
        'close_label': 'Закрыть форму',
        'hidden_fields': [
            {'name': 'form_type', 'value': event_form_mode or 'create'},
            {'name': 'event_id', 'value': event_form_event_id or ''},
            {'name': 'current_step', 'value': event_form.get('current_step', 'basic')},
        ]
    } %}
    {% call management_modal(event_modal_config) %}
        <div class="events-modal__stepper" data-event-stepper data-event-initial-step="{{ current_step_value }}">
            <button type="button" class="events-modal__step" data-event-step-button data-event-step-value="basic">
                <span class="events-modal__step-index">1</span>
                <span class="events-modal__step-label">Основное</span>
            </button>
            <button type="button" class="events-modal__step" data-event-step-button data-event-step-value="teachers">
                <span class="events-modal__step-index">2</span>
                <span class="events-modal__step-label">Учителя</span>
            </button>
        </div>

        <div class="events-modal__stages" data-event-stages data-event-initial-step="{{ current_step_value }}">
            <section class="events-modal__stage" data-event-stage="basic" aria-labelledby="events-modal-step-basic-title">
                <header class="events-modal__stage-header">
                    <div>
                        <h3 id="events-modal-step-basic-title" class="events-modal__stage-title">Основная информация</h3>
                        <p class="events-modal__stage-hint">Заполните ключевые параметры мероприятия</p>
                    </div>
                </header>
                <div class="events-modal__stage-body">
                    <div class="input-fields-container__row">
                        <label class="input-fields-container__row-label" for="event_name">Название</label>
                        <input id="event_name" name="name" type="text" class="input-fields-container__row-input" value="{{ event_form.get('name', '') }}" maxlength="120" required>
                    </div>
                    <div class="input-fields-container__row">
                        <label class="input-fields-container__row-label" for="event_start_time">Начало</label>
                        <input id="event_start_time" name="start_time" type="datetime-local" class="input-fields-container__row-input" value="{{ event_form.get('start_time', '') }}" required>
                    </div>
                    <div class="input-fields-container__row">
                        <label class="input-fields-container__row-label" for="event_consultations_count">Количество консультаций</label>
                        <input id="event_consultations_count" name="consultations_count" type="number" class="input-fields-container__row-input" value="{{ event_form.get('consultations_count', '1') }}" min="1" step="1" required>
                    </div>
                    <div class="input-fields-container__row">
                        <label class="input-fields-container__row-label" for="event_consultation_duration">Длительность консультации, мин</label>
                        <input id="event_consultation_duration" name="consultation_duration_minutes" type="number" class="input-fields-container__row-input" value="{{ event_form.get('consultation_duration_minutes', '15') }}" min="1" step="1" required>
                    </div>
                    <div class="input-fields-container__row input-fields-container__row--computed">
                        <span class="input-fields-container__row-label">Окончание</span>
                        <output id="event_end_preview" class="input-fields-container__computed" data-event-end-preview>{{ event_form.get('calculated_end_time', '') }}</output>
                    </div>
                </div>
            </section>
            <section class="events-modal__stage" data-event-stage="teachers" aria-labelledby="events-modal-step-teachers-title">
                <header class="events-modal__stage-header">
                    <div>
                        <h3 id="events-modal-step-teachers-title" class="events-modal__stage-title">Учителя мероприятия</h3>
                        <p class="events-modal__stage-hint">Выберите педагогов, которые будут участвовать</p>
                    </div>
                    {% if teacher_options | length > 0 %}
                    <div class="events-modal__teachers-actions">
                        <label class="events-modal__select-all">
                            <input type="checkbox" class="events-modal__select-all-checkbox" data-event-teachers-select-all {% if all_teachers_selected %}checked{% endif %}>
                            <span>Выбрать всех</span>
                        </label>
                        <span class="events-modal__selected-counter">Выбрано: <span data-event-teachers-count>{{ selected_teacher_ids | length }}</span></span>
                    </div>
                    {% endif %}
                </header>
                <div class="events-modal__stage-body events-modal__stage-body--teachers">
                    {% if teacher_options | length > 0 %}
                    <div class="events-modal__teachers-list" data-event-teachers-list role="group" aria-label="Учителя школы">
                        {% for teacher in teacher_options %}
                            {% set teacher_id_str = teacher.id | string %}
                            {% set is_checked = teacher_id_str in selected_teacher_ids %}
                            <label class="events-modal__teacher" data-event-teacher-item>
                                <input type="checkbox"
                                       class="events-modal__teacher-checkbox"
                                       name="teacher_ids"
                                       value="{{ teacher.id }}"
                                       data-event-teacher-checkbox
                                       {% if is_checked %}checked{% endif %}>
                                <span class="events-modal__teacher-name">{{ teacher.name }}</span>
                                <span class="events-modal__teacher-email">{{ teacher.email }}</span>
                            </label>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="events-modal__teachers-empty">В вашей школе пока нет учителей. Добавьте их позже в разделе «Учителя», чтобы назначать на мероприятие.</p>
                    {% endif %}
                </div>
            </section>
        </div>

        <div class="events-modal__navigation" data-event-navigation>
            <button type="button" class="button button--outline events-modal__nav-button" data-event-step-prev>Назад</button>
            <div class="events-modal__navigation-actions">
                <button type="button" class="button main-button events-modal__nav-button" data-event-step-next>Далее</button>
            </div>
        </div>
    {% endcall %}
    {{ management_delete_form('events', 'event_id') }}
    {% endif %}
</section>
</main>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if can_manage_events %}
<script type="module" src="{{ url_for('static', filename='js/pages/events/index.js') }}"></script>
{% endif %}
{% endblock %}
